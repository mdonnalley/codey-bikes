name: Fix issues with Codey

on:
    issues:
        types: [opened]

jobs:
    run-script:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Clone gemini-cli repository
              run: |
                  git clone https://github.com/mdonnalley/gemini-cli.git
                  cd gemini-cli
                  npm install
                  npm run build

            - name: Codey will fix it
              run: |
                  echo "Running Codey..."
                  echo "Issue number: ${{ github.event.issue.number }}"
                  echo "Issue title: ${{ github.event.issue.title }}"
                  echo "Issue author: ${{ github.event.issue.user.login }}"
                  node gemini-cli/scripts/start.js --prompt "${{ github.event.issue.body }}" --yolo
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.issue.number }}
                  ISSUE_TITLE: ${{ github.event.issue.title }}
                  ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
                  ISSUE_BODY: ${{ github.event.issue.body }}

            - name: Create branch and commit changes
              run: |
                  # Configure git
                  git config --local user.email "codey@agentic-cli.com"
                  git config --local user.name "Codey"

                  # Create and switch to new branch
                  BRANCH_NAME="issue-${{ github.event.issue.number }}-automated-changes"
                  git checkout -b "$BRANCH_NAME"

                  # Add all changes
                  git add -A

                  # Check if there are changes to commit
                  if git diff --cached --quiet; then
                    echo "No changes to commit"
                    exit 0
                  fi

                  # Commit changes
                  git commit -m "Automated changes for issue #${{ github.event.issue.number }}

                  Generated by gemini-cli script in response to:
                  ${{ github.event.issue.title }}

                  Closes #${{ github.event.issue.number }}"

                  # Push the branch
                  git push origin "$BRANCH_NAME"

            - name: Create Pull Request
              uses: actions/github-script@v7
              with:
                  script: |
                      const branchName = `issue-${{ github.event.issue.number }}-automated-changes`;

                      try {
                          const { data: pullRequest } = await github.rest.pulls.create({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              title: `Automated changes for issue #${{ github.event.issue.number }}`,
                              head: branchName,
                              base: 'main',
                              body: `This PR contains automated changes generated in response to issue #${{ github.event.issue.number }}.

                      **Original Issue:** ${{ github.event.issue.title }}
                      **Issue Author:** @${{ github.event.issue.user.login }}
                      **Generated by:** gemini-cli script

                      Please review the changes before merging.

                      Closes #${{ github.event.issue.number }}`
                          });

                          console.log(`Created PR #${pullRequest.number}: ${pullRequest.html_url}`);

                          // Comment on the original issue with PR link
                          await github.rest.issues.createComment({
                              issue_number: ${{ github.event.issue.number }},
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              body: `ü§ñ I've created a pull request with automated changes: #${pullRequest.number}

                      Please review the changes and merge if they look good!`
                          });

                      } catch (error) {
                          console.error('Error creating PR:', error);

                          // Comment on issue if PR creation fails
                          await github.rest.issues.createComment({
                              issue_number: ${{ github.event.issue.number }},
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              body: `‚ùå Failed to create pull request with automated changes. Please check the workflow logs for details.`
                          });
                      }
